name: Update Releases

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch (adjust as necessary)

jobs:
  update-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get the latest release tag
        id: get_latest_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_release=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "Latest release tag: $latest_release"
          echo "latest_release=${latest_release}" >> $GITHUB_ENV

      - name: Fetch the latest release tag from remote
        if: env.latest_release != ''
        run: |
          git fetch origin refs/tags/${{ env.latest_release }}:refs/tags/${{ env.latest_release }}

      - name: Get changed files since latest release
        id: get_changes
        run: |
          if [ -n "${{ env.latest_release }}" ]; then
            git fetch origin refs/tags/${{ env.latest_release }}:refs/tags/${{ env.latest_release }}
            changed_files=$(git diff --name-only ${{ env.latest_release }} HEAD)
            echo "Changed files since ${{ env.latest_release }}: $changed_files"
            echo "$changed_files" > changed_files.txt
          else
            echo "No latest release found"
            echo "" > changed_files.txt
          fi

      - name: Read changed files
        id: read_changed_files
        run: |
          changed_files=$(paste -sd, changed_files.txt)
          echo "changed_files=${changed_files}" >> $GITHUB_ENV
          
      - name: Upload changed files to the release
        if: env.changed_files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IFS=',' read -r -a files <<< "${{ env.changed_files }}"
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release ${{ env.latest_release }}"
              gh release upload ${{ env.latest_release }} "$file" --clobber
            else
              echo "File $file not found"
            fi
          done